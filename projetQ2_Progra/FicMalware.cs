using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace projetQ2_Progra
{
    public partial class FicMalware : Form
    {
        private readonly Random _rnd = new Random();
        private bool _isClosingForReal = false;

        public FicMalware()
        {
            InitializeComponent();

            this.Shown += (s, e) => this.Activate();

            this.FormBorderStyle = FormBorderStyle.None;
            this.StartPosition = FormStartPosition.CenterScreen;
            this.TopMost = true;
            this.KeyPreview = true;
            this.BackColor = Color.Magenta;   
            this.TransparencyKey = Color.Magenta; 

            
            this.ClientSize = new Size(260, 260);

            
            this.Load += FicMalware_Load;
            this.MouseMove += FicMalware_MouseMove;
            this.FormClosing += FicMalware_FormClosing;
            this.KeyDown += FicMalware_KeyDown;
            this.Resize += FicMalware_Resize;
            this.Paint += FicMalware_Paint;
        }

        private void FicMalware_Load(object sender, EventArgs e)
        {
            AppliquerFormeEtoile();
        }

        private void FicMalware_Resize(object sender, EventArgs e)
        {
            AppliquerFormeEtoile();
            this.Invalidate();
        }

        
        private void FicMalware_FormClosing(object sender, FormClosingEventArgs e)
        {
            if (_isClosingForReal) return;

            e.Cancel = true;

            
            var f = new FicMalware();
            f.StartPosition = FormStartPosition.Manual;
            f.Location = new Point(this.Left + 30, this.Top + 30);
            f.Show();
        }

        
        private void FicMalware_KeyDown(object sender, KeyEventArgs e)
        {
             if (e.KeyCode == Keys.F4)
             {
                 this.Close(); 
                 return;
             }


             if (e.KeyCode == Keys.Escape)
             {
                 _isClosingForReal = true;
                 this.Close();
             }
        }

        protected override bool ProcessCmdKey(ref Message msg, Keys keyData)
        {
            if (keyData == Keys.Escape)
            {
                _isClosingForReal = true;
                this.Close();
                return true;
            }

            if (keyData == Keys.F4)
            {
                this.Close(); 
                return true;
            }

            return base.ProcessCmdKey(ref msg, keyData);
        }

        
        private void FicMalware_MouseMove(object sender, MouseEventArgs e)
        {
            
            Point souris = Cursor.Position;

            
            if (this.Bounds.Contains(souris))
            {
                Rectangle zone = Screen.FromControl(this).WorkingArea;

                int dx = _rnd.Next(120, 220);
                int dy = _rnd.Next(80, 180);

                
                if (_rnd.Next(2) == 0) dx = -dx;
                if (_rnd.Next(2) == 0) dy = -dy;

                int newX = this.Left + dx;
                int newY = this.Top + dy;

                
                if (newX < zone.Left) newX = zone.Right - this.Width;
                if (newX + this.Width > zone.Right) newX = zone.Left;

                if (newY < zone.Top) newY = zone.Bottom - this.Height;
                if (newY + this.Height > zone.Bottom) newY = zone.Top;

                this.Location = new Point(newX, newY);
            }
        }

        
        private void FicMalware_Paint(object sender, PaintEventArgs e)
        {
            e.Graphics.SmoothingMode = SmoothingMode.AntiAlias;

            using (GraphicsPath star = CreerEtoilePath(this.ClientRectangle, 5, 0.45f))
            using (Brush b = new SolidBrush(Color.Gold))
            using (Pen p = new Pen(Color.OrangeRed, 6))
            {
                e.Graphics.FillPath(b, star);
                e.Graphics.DrawPath(p, star);
            }
        }

        
        private void AppliquerFormeEtoile()
        {
            using (GraphicsPath star = CreerEtoilePath(this.ClientRectangle, 5, 0.45f))
            {
                this.Region = new Region(star);
            }
        }

        private GraphicsPath CreerEtoilePath(Rectangle rect, int branches, float innerRatio)
        {
            GraphicsPath path = new GraphicsPath();

            float cx = rect.Left + rect.Width / 2f;
            float cy = rect.Top + rect.Height / 2f;

            float outerR = Math.Min(rect.Width, rect.Height) * 0.48f;
            float innerR = outerR * innerRatio;

            int points = branches * 2; 
            PointF[] pts = new PointF[points];

            double angle = -Math.PI / 2; 
            double step = Math.PI / branches;

            for (int i = 0; i < points; i++)
            {
                float r = (i % 2 == 0) ? outerR : innerR;
                pts[i] = new PointF(
                    cx + (float)(Math.Cos(angle) * r),
                    cy + (float)(Math.Sin(angle) * r)
                );
                angle += step;
            }

            path.AddPolygon(pts);
            path.CloseFigure();
            return path;
        }
    }

}
